{% extends 'base.html' %}
{% load heroicons %}

{% block title %}CAB Rejection Analysis{% endblock %}

{% block sidebar %}

<div class="flex flex-col w-64 h-full p-4  font-sans bg-gray-50">
    <!-- Panel Header -->
    <div class="mb-6 p-4 rounded-lg shadow-md bg-white">
        <h1 class="text-xl font-bold text-gray-800">
            CAB
        </h1>
    </div>

    <!-- Navigation Links -->
    <nav class="flex-1 space-y-1">
        <ul class="dashboard-menu">
            <li>
                <a href="{% url 'cab' %}" 
                   class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-gray-700 {% if request.resolver_match.url_name == 'admin_dashboard' %}bg-gray-100 font-semibold{% endif %} hover:bg-gray-100">
                    {% heroicon_outline "home" class="w-5 h-5" %}CAB Dashboard
                </a>
            </li>
            <li>
                <a href="{% url 'cab_stats' %}" 
                   class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-100">
                    {% heroicon_outline "chart-pie" class="w-5 h-5" %}Statistics
                </a>
            </li>
        </ul>
    </nav>

    <!-- Logout anchored at bottom -->
    <div class="mt-auto">
        <a href="{% url 'logout' %}" 
           class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium bg-gray-700 text-white hover:bg-red-500 hover:text-white">
            {% heroicon_outline "arrow-left-on-rectangle" class="w-5 h-5" %}Logout
        </a>
    </div>
</div>

{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-8">
    <h2 class="text-2xl font-semibold text-center text-gray-800 mb-2">CAB Requests</h2>
    <p class="text-gray-500 text-center mb-6">Overview of all CAB requests</p>
    </div>

    <div id="rejectionChart" class="overflow-x-auto p-4 px-4 py-6 shadow-xl border border-gray-200 rounded-lg"></div>
</div>

<!-- Highcharts JS -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const data = [
        {{ analytics.resource_constraints }},
        {{ analytics.incomplete_rollback_plan }},
        {{ analytics.no_business_justification }},
        {{ analytics.high_risk }},
        {{ analytics.insufficient_info }}
    ];

    const labels = [
        'Resource Constraints',
        'Incomplete Rollback Plan',
        'No Business Justification',
        'High Risk',
        'Insufficient Info'
    ];

    const total = data.reduce((a, b) => a + b, 0);

    Highcharts.chart('rejectionChart', {
        chart: {
            type: 'bar',
            backgroundColor: 'transparent',
        },
        title: { text: null },
        xAxis: {
            categories: labels,
            title: { text: null },
            labels: { style: { color: '#111827', fontWeight: '500' } }
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Number of Rejections',
                style: { color: '#111827', fontWeight: '600' }
            },
            labels: { style: { color: '#6B7280', fontWeight: '500' } },
            gridLineColor: '#E5E7EB'
        },
        tooltip: {
            formatter: function() {
                const pct = ((this.y / total) * 100).toFixed(1);
                return `<b>${this.x}</b>: ${this.y} (${pct}%)`;
            }
        },
        plotOptions: {
            series: {
                dataLabels: {
                    enabled: true,
                    formatter: function() {
                        const pct = ((this.y / total) * 100).toFixed(1);
                        return `${this.y} (${pct}%)`;
                    },
                    style: { fontWeight: '500', color: '#111827' }
                },
                color: '#3B82F6', // Tailwind blue-500
                borderRadius: 4,
            }
        },
        legend: { enabled: false },
        credits: { enabled: false },
        series: [{ name: 'Rejections', data: data }]
    });
});
</script>
{% endblock %}
